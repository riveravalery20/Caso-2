---
title: "Análisis Profesional"
author: "Joan Aguirre"
date: "2025-10-27"
output:
  rmdformats::readthedown:
    css: Valery-styles.css
    self_contained: true
    thumbnails: false
    gallery: false
    number_sections: false
    toc_depth: 3
    use_bookdown: false
---

```{r librerias, warning=FALSE,message=FALSE}
library(kableExtra)
library(readr)
library(dplyr)
library(tidyverse)
library(kableExtra)
library(reactable)
library(plotly)
library(htmltools)
library(ggplot2)
```


```{r tema , echo=FALSE}
Valery_css =
"  
/* PALETA ACADÉMICA MARINA PROFESIONAL */
:root {
  --deep-ocean: #2C5F7A;         /* Azul marino profundo */
  --ocean-teal: #3A8E96;         /* Verde azulado principal */
  --sea-glass: #4FB0A8;          /* Turquesa suave */
  --seafoam: #8FD4C1;            /* Espuma de mar */
  --mist: #F8FCFB;               /* Blanco académico con tono marino suave */
  --parchment: #FDFDF6;          /* Color pergamino académico */
  --coral: #D94E4E;              /* Acento coral sobrio */
  --dark-ink: #2C3E50;           /* Color tinta para texto */
  --light-ink: #4A6572;          /* Texto secundario */
  --border-light: #E1F0ED;       /* Bordes sutiles */
  --accent-gold: #C4A747;        /* Dorado académico */
}

/* IMPORTAR FUENTES ACADÉMICAS */
@import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Source+Serif+Pro:wght@300;400;600&family=Lato:wght@300;400;700&display=swap');

/* ESTILOS BASE ACADÉMICOS */
body {
  font-family: 'Source Serif Pro', 'Georgia', 'Times New Roman', serif;
  font-weight: 400;
  line-height: 1.7;
  color: var(--dark-ink);
  background-color: var(--parchment);
  font-size: 17px;
  text-align: justify;
}

.main-content {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 3rem;
  background: var(--mist);
  box-shadow: 
    0 5px 30px rgba(42, 95, 122, 0.08),
    0 1px 3px rgba(0,0,0,0.03);
  border-radius: 4px;
  border: 1px solid var(--border-light);
  position: relative;
}

/* ENCABEZADOS ACADÉMICOS */
h1, h2, h3, h4, h5, h6 {
  font-family: 'Merriweather', 'Georgia', 'Times New Roman', serif;
  color: var(--deep-ocean) !important;
  margin-top: 2.5rem;
  margin-bottom: 1.2rem;
  font-weight: 600;
  line-height: 1.3;
  text-align: left;
}

h1 {
  font-size: 2.6rem;
  font-weight: 700;
  text-align: center;
  margin-bottom: 2rem;
  padding-bottom: 1.2rem;
  border-bottom: 3px double var(--sea-glass);
  color: var(--deep-ocean) !important;
  background: none;
  -webkit-text-fill-color: var(--deep-ocean);
  letter-spacing: -0.5px;
}

h2 {
  font-size: 2rem;
  border-left: 4px solid var(--ocean-teal);
  padding-left: 1.2rem;
  margin-top: 3rem;
  background: linear-gradient(90deg, rgba(79, 176, 168, 0.08) 0%, transparent 100%);
  padding: 0.8rem 1.2rem;
  border-radius: 0;
  position: relative;
  font-weight: 600;
}

h3 {
  font-size: 1.5rem;
  color: var(--ocean-teal) !important;
  border-bottom: 1px solid var(--border-light);
  padding-bottom: 0.5rem;
  margin-top: 2.2rem;
  font-weight: 600;
}

h4 {
  font-size: 1.3rem;
  color: var(--sea-glass) !important;
  margin-top: 1.8rem;
  font-style: italic;
}

h5 {
  font-size: 1.1rem;
  color: var(--light-ink) !important;
  margin-top: 1.5rem;
}

/* TOC ACADÉMICO MEJORADO - PARTE IZQUIERDA */
#TOC {
  background: linear-gradient(135deg, var(--mist) 0%, #F0F9F7 100%) !important;
  border: 1px solid var(--border-light) !important;
  border-radius: 6px !important;
  padding: 2rem 1.5rem !important;
  margin: 2rem 0 !important;
  box-shadow: 0 2px 12px rgba(42, 95, 122, 0.06) !important;
  font-family: 'Merriweather', serif !important;
}



#TOC ul {
  list-style: none !important;
  padding-left: 0 !important;
  margin: 0 !important;
}

#TOC li {
  margin: 0.7rem 0 !important;
  padding: 0.4rem 0.8rem !important;
  border-left: 3px solid transparent;
  border-radius: 0;
  transition: all 0.2s ease;
  font-size: 0.95rem;
}

#TOC li:hover {
  border-left-color: var(--ocean-teal);
  background: rgba(79, 176, 168, 0.05);
  transform: translateX(3px);
}

#TOC a {
  color: var(--light-ink) !important;
  text-decoration: none !important;
  font-weight: 500 !important;
  transition: all 0.2s ease !important;
  font-family: 'Source Serif Pro', serif !important;
  display: block;
  padding: 0.2rem 0;
}

#TOC a:hover {
  color: var(--deep-ocean) !important;
  background: none !important;
}

#TOC ul ul {
  padding-left: 1.2rem !important;
  margin-top: 0.3rem !important;
  border-left: 1px solid var(--border-light);
}

#TOC ul ul li {
  margin: 0.4rem 0 !important;
  padding: 0.2rem 0.6rem !important;
  font-size: 0.9rem;
}

#TOC ul ul a {
  color: var(--light-ink) !important;
  font-weight: 400 !important;
}

/* CONTENEDOR PRINCIPAL */
.container-fluid {
  background: linear-gradient(135deg, #F5FBFA 0%, var(--parchment) 100%);
  min-height: 100vh;
  padding: 1.5rem;
}

/* HEADER ACADÉMICO */
.page-header {
  background: linear-gradient(135deg, var(--deep-ocean) 0%, var(--ocean-teal) 100%) !important;
  color: white;
  padding: 3.5rem 2rem !important;
  text-align: center;
  margin-bottom: 2.5rem !important;
  border-radius: 0;
  position: relative;
  overflow: hidden;
  border-bottom: 4px solid var(--sea-glass);
}

.page-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 60%);
}

.page-header h1 {
  color: white !important;
  font-size: 2.8rem;
  font-weight: 700;
  border: none;
  background: none;
  -webkit-text-fill-color: white;
  text-shadow: 0 1px 3px rgba(0,0,0,0.3);
  position: relative;
  z-index: 2;
  margin-bottom: 0.5rem;
}

.page-header h2 {
  color: rgba(255,255,255,0.95) !important;
  font-size: 1.4rem;
  font-weight: 300;
  border: none;
  background: none;
  font-family: 'Source Serif Pro', serif;
  position: relative;
  z-index: 2;
  margin-top: 0.5rem;
}

/* BLOQUES DE CÓDIGO ACADÉMICOS */
pre {
  background: #f8f9fa !important;
  color: var(--dark-ink) !important;
  padding: 1.2rem !important;
  border: 1px solid var(--border-light) !important;
  border-radius: 4px !important;
  border-left: 4px solid var(--ocean-teal) !important;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
  font-size: 0.85em;
  line-height: 1.5;
  margin: 1.2rem 0;
}

code {
  background: rgba(79, 176, 168, 0.1) !important;
  color: var(--ocean-teal) !important;
  padding: 0.15rem 0.4rem !important;
  border-radius: 3px;
  font-family: 'Consolas', 'Monaco', monospace !important;
  font-size: 0.8em;
  border: 1px solid rgba(79, 176, 168, 0.2);
}

/* TABLAS ACADÉMICAS */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 1.8rem 0;
  box-shadow: 0 1px 4px rgba(42, 95, 122, 0.08);
  border: 1px solid var(--border-light);
  border-radius: 4px;
  overflow: hidden;
  font-family: 'Lato', sans-serif;
}

th {
  background: linear-gradient(135deg, var(--ocean-teal), var(--deep-ocean)) !important;
  color: white !important;
  font-weight: 600;
  padding: 0.9rem !important;
  text-align: left;
  border: none !important;
  font-family: 'Lato', sans-serif;
  font-size: 0.9rem;
}

td {
  padding: 0.8rem !important;
  border: none !important;
  border-bottom: 1px solid var(--border-light) !important;
  font-size: 0.9rem;
}

tr:nth-child(even) {
  background: rgba(143, 212, 193, 0.05) !important;
}

tr:hover {
  background: rgba(79, 176, 168, 0.08) !important;
}

/* GRÁFICOS ACADÉMICOS */
.plotly.html-widget {
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(42, 95, 122, 0.1);
  padding: 0.8rem;
  background: white;
  border: 1px solid var(--border-light);
  margin: 1.5rem 0;
}

/* BOTONES ACADÉMICOS */
.btn {
  background: linear-gradient(135deg, var(--ocean-teal), var(--sea-glass)) !important;
  color: white !important;
  border: none !important;
  padding: 0.6rem 1.2rem !important;
  border-radius: 4px !important;
  font-weight: 500 !important;
  transition: all 0.2s ease !important;
  box-shadow: 0 1px 4px rgba(58, 142, 150, 0.3) !important;
  font-family: 'Lato', sans-serif !important;
}

.btn:hover {
  transform: translateY(-1px) !important;
  box-shadow: 0 2px 8px rgba(58, 142, 150, 0.4) !important;
}

/* FOOTER ACADÉMICO */
.academic-footer {
  text-align: center;
  color: var(--ocean-teal);
  margin-top: 4rem;
  padding: 2.5rem 2rem;
  border-top: 2px solid var(--border-light);
  background: var(--mist);
  font-family: 'Merriweather', serif;
  font-size: 0.9rem;
}

/* CITAS Y BLOCKQUOTES */
blockquote {
  border-left: 4px solid var(--sea-glass);
  background: rgba(143, 212, 193, 0.05);
  padding: 1rem 1.5rem;
  margin: 1.5rem 0;
  font-style: italic;
  color: var(--light-ink);
  border-radius: 0 4px 4px 0;
}

/* LISTAS ACADÉMICAS */
ul, ol {
  padding-left: 1.8rem;
  margin: 1.2rem 0;
}

li {
  margin: 0.5rem 0;
  line-height: 1.6;
}

/* RESPONSIVE DESIGN ACADÉMICO */
@media (max-width: 768px) {
  .main-content {
    padding: 1.5rem;
    margin: 1rem;
    border-radius: 0;
  }
  
  h1 {
    font-size: 2rem;
  }
  
  h2 {
    font-size: 1.6rem;
    padding: 0.6rem 1rem;
  }
  
  .page-header {
    padding: 2.5rem 1rem !important;
  }
  
  .page-header h1 {
    font-size: 2rem;
  }
  
  #TOC {
    padding: 1.5rem 1rem !important;
    margin: 1.5rem 0 !important;
  }
}

/* ENLACES ACADÉMICOS */
a {
  color: var(--ocean-teal);
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: all 0.2s ease;
}

a:hover {
  color: var(--deep-ocean);
  border-bottom-color: var(--sea-glass);
}

/* SCROLLBAR DISCRETO */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: var(--mist);
}

::-webkit-scrollbar-thumb {
  background: var(--sea-glass);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--ocean-teal);
}

/* CONTROLES DE CÓDIGO ACADÉMICOS */
.code-toggle-container {
  text-align: center;
  margin: 3rem 0 2rem 0;
  padding: 2rem;
  background: linear-gradient(135deg, var(--mist) 0%, #F0F9F7 100%);
  border-radius: 8px;
  border: 1px solid var(--border-light);
  box-shadow: 0 2px 12px rgba(42, 95, 122, 0.08);
  border-left: 4px solid var(--ocean-teal);
}

.code-toggle-container h4 {
  margin-top: 0 !important;
  color: var(--deep-ocean) !important;
  font-family: 'Merriweather', serif !important;
  font-size: 1.3rem !important;
  border: none !important;
  background: none !important;
  padding: 0 !important;
}

.code-toggle-container p {
  color: var(--light-ink) !important;
  margin-bottom: 1.5rem !important;
  font-family: 'Source Serif Pro', serif !important;
  font-size: 0.95rem !important;
}

.code-toggle-btn {
  background: linear-gradient(135deg, var(--ocean-teal), var(--sea-glass));
  color: white !important;
  border: none;
  padding: 0.8rem 1.5rem;
  border-radius: 6px;
  font-family: 'Lato', sans-serif;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(58, 142, 150, 0.3);
  margin: 0 0.5rem 0.5rem 0;
}

.code-toggle-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(58, 142, 150, 0.4);
  background: linear-gradient(135deg, var(--sea-glass), var(--ocean-teal));
}

.code-toggle-btn.secondary {
  background: linear-gradient(135deg, var(--seafoam), var(--sea-glass));
  color: var(--dark-ink) !important;
}

.code-toggle-btn.secondary:hover {
  background: linear-gradient(135deg, var(--sea-glass), var(--seafoam));
}

/* BOTÓN FLOTANTE GLOBAL */
.global-code-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  background: linear-gradient(135deg, var(--ocean-teal), var(--deep-ocean));
  color: white;
  border: none;
  padding: 0.8rem 1.2rem;
  border-radius: 25px;
  font-family: 'Lato', sans-serif;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(42, 95, 122, 0.4);
  transition: all 0.3s ease;
}

.global-code-toggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(42, 95, 122, 0.6);
}

/* CONTENEDORES DE CÓDIGO CON TOGGLE */
.code-chunk {
  margin: 2rem 0;
  border: 1px solid var(--border-light);
  border-radius: 6px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(42, 95, 122, 0.08);
  transition: all 0.3s ease;
}

.code-chunk:hover {
  box-shadow: 0 4px 15px rgba(42, 95, 122, 0.12);
}

.code-header {
  background: linear-gradient(135deg, var(--ocean-teal), var(--deep-ocean));
  color: white;
  padding: 1rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Lato', sans-serif;
}

.code-header:hover {
  background: linear-gradient(135deg, var(--deep-ocean), var(--ocean-teal));
}

.chunk-title {
  font-family: 'Lato', sans-serif;
  font-weight: 600;
  font-size: 0.95rem;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.toggle-icon {
  font-family: 'Lato', sans-serif;
  font-weight: 700;
  font-size: 0.9rem;
  transition: transform 0.3s ease;
}

.toggle-icon.rotated {
  transform: rotate(180deg);
}

.code-content {
  background: #f8f9fa;
  transition: all 0.3s ease;
  overflow: hidden;
}

.code-content.collapsed {
  max-height: 0;
  opacity: 0;
  padding: 0;
}

.code-content.expanded {
  max-height: 5000px;
  opacity: 1;
  padding: 1rem;
}

/* INDICADOR DE ESTADO */
.code-status {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 8px;
}

.code-status.visible {
  background: #4CAF50;
  box-shadow: 0 0 5px #4CAF50;
}

.code-status.hidden {
  background: #FF9800;
  box-shadow: 0 0 5px #FF9800;
}

/* SMOOTH SCROLL Y NAVEGACIÓN */
html {
  scroll-behavior: smooth;
}

/* Resaltado de sección activa en TOC */
.tocify-item a.active {
  color: var(--deep-ocean) !important;
  font-weight: 600 !important;
  border-left: 3px solid var(--ocean-teal) !important;
  background: rgba(79, 176, 168, 0.1) !important;
}

/* RESPONSIVE PARA CONTROLES */
@media (max-width: 768px) {
  .code-toggle-container {
    padding: 1.5rem 1rem;
    margin: 2rem 0 1rem 0;
  }
  
  .code-toggle-btn {
    display: block;
    width: 100%;
    margin: 0.5rem 0;
  }
  
  .global-code-toggle {
    padding: 0.6rem 1rem;
    font-size: 0.8rem;
    top: 10px;
    right: 10px;
  }
  
  .code-header {
    padding: 0.8rem 1rem;
  }
  
  .chunk-title {
    font-size: 0.85rem;
  }
}
"

writeLines(Valery_css, "Valery-styles.css")

```


# Introducción

::: content-block
El peso al nacer es uno de los determinantes más importantes del bienestar con el que un ser humano inicia su vida. Es un indicador de morbilidad y mortalidad pediátrica y neonatal, así como un antecedente clave en las diferencias del desarrollo cognitivo y de las enfermedades crónicas en etapas posteriores. Sin embargo, también representa una problemática multifactorial en la que intervienen diversas fallas sociales, como la desigualdad económica, el acceso a la salud, las condiciones de vida y la educación en salud materno-infantil. Todo esto genera brechas en las propiedades intelectuales y materiales durante una etapa tan vital y crítica como el desarrollo óptimo de los nacidos vivos del país, lo que produce impactos en los niveles de natalidad, el desarrollo de niños y adolescentes, y en las madres presentes y futuras.

Un recién nacido con bajo peso y/o desnutrición no solo refleja una falta de responsabilidad materna hacia su hijo, sino también las brechas que impiden que las madres accedan a un seguimiento adecuado y controlado de su embarazo. Esto les dificulta vivir este proceso de manera tranquila y exitosa, y hace que sus hijos no inicien sus primeros momentos de vida de forma satisfactoria.

Como se mencionó anteriormente, el desarrollo prenatal del bebé representa uno de los factores más influyentes desde el punto de vista social, ya que engloba y describe las condiciones del entorno en el que nace el individuo y en el que probablemente transitara las etapas futuras de su desarrollo. Lo anterior se resume en las particularidades del embarazo de las madres de los recién nacidos vivos. Estos aspectos se abordarán en el desarrollo de la presente investigación, puesto que desde el área de la ingeniería es posible realizar una prospectiva de la situación, facilitando la formulación de soluciones desde un enfoque social.

A pesar de que los antecedentes corresponden a una problemática nacional, Bogotá, a pesar de ser la capital del país y contar con un mejor desarrollo regional, no está exenta de ella. Según datos del DANE, el 17% de los casos de desnutrición neonatal del segundo semestre del año 2024 corresponden a esta ciudad.

El presente estudio emplea modelos de clasificación supervisada (regresión logística y KNN) utilizando los datos de nacimientos vivos en Bogotá, con el objetivo de analizar la relación entre la desnutrición neonatal y un conjunto de variables explicativas. Entre estas, se consideran el tiempo de gestación, el tipo de parto, el número de controles prenatales, la edad materna y el número de embarazos previos. La selección de estas variables se fundamenta tanto en la revisión de literatura científica relevante como en las características sociodemográficas y sanitarias propias del contexto bogotano, las cuales han sido identificadas en informes nacionales y estudios previos como factores determinantes en el estado nutricional al nacer.
:::


```{r tabla_variables}
# TABLA DE VARIABLES DEL MODELO
variables_modelo <- data.frame(
  Variable = c("Peso", "Tiempo gestación", "Tipo parto", 
               "Numero control prenatal", "Edad madre", "Numero embarazos"),
  Descripción = c("Clasificación del peso al nacer (Normal/Delicado)",
                 "Semanas de gestación", 
                 "Tipo de parto registrado",
                 "Número de controles prenatales realizados",
                 "Grupo etario de la madre",
                 "Número de embarazos previos"),
  Tipo_Variable = c("Categórica (binaria)", "Categórica ordinal", 
                   "Categórica nominal", "Cuantitativa discreta",
                   "Categórica ordinal", "Cuantitativa discreta"),
  Notas = c("Variable dependiente - Peso normal: ≥2500g", 
           "Considerar <37 semanas como prematurez",
           "Espontáneo/Cesárea/Instrumentado",
           "Indicador de acceso a salud prenatal",
           "Recodificado a 9 rangos etarios (Códigos 1 a 9)",
           "Incluye embarazo actual")
)

kable(variables_modelo, 
      caption = "Tabla 1: Variables del Modelo",
      align = c("l", "l", "l", "l"),
      col.names = c("Variable", "Descripción", "Tipo de Variable", "Notas")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE,
                font_size = 12) %>%
  row_spec(0, background = "#2C3E50", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "12em") %>%
  footnote(general = "Fuente: Elaboración propia en base a la Base de Datos de Nacimientos - 2024",
           number = c("Datos corresponden al segundo semestre del año 2024"))
```


# Metodología y Datos

:::: content-block
**Base de datos:** Encuesta de estadísticas vitales - EEVV - 2024

**Unidad de análisis:** Nacimiento

**Período:** (2024)

**Acceso:** [https://microdatos.dane.gov.co/index.php/catalog/878](https://microdatos.dane.gov.co/index.php/catalog/878/data-dictionary/F46?file_name=BD-EEVV-Nacimientos-2024){.uri}

Los datos utilizados en esta investigación provienen de la Encuesta de Estadísticas Vitales (EEVV) 2024 del Departamento Administrativo Nacional de Estadística (DANE). Esta encuesta administra el registro administrativo de nacimientos en Colombia y recoge información detallada sobre características demográficas, sociales y clínicas relacionadas con el recién nacido y su madre.

La metodología de esta investigación se basa en la aplicación de dos modelos de clasificación supervisada, K-Nearest Neighbors (KNN) y Regresión Logística, con el objetivo de identificar y analizar las fallas sociales y estructurales que inciden en la desnutrición neonatal en Bogotá durante el segundo semestre de 2024. Estos modelos permiten determinar la influencia de variables sociales, económicas y de salud en este problema de salud pública, tomando como indicador principal la desnutrición al nacer.

La selección de variables incluye aspectos educativos, económicos y estructurales que reflejan el control social desde la concepción hasta el nacimiento, así como parámetros clínicos relevantes. Esto garantiza un análisis integral de los determinantes del estado nutricional neonatal.

El estudio utiliza una base de datos representativa y actualizada proveniente de la Encuesta de Estadísticas Vitales (EEVV) 2024 del DANE, focalizando su análisis en la población nacida en Bogotá durante ese periodo. El proceso metodológico contempla etapas rigurosas de preprocesamiento de datos, incluyendo limpieza, manejo de valores faltantes y balance de clases, así como la partición de los datos en conjuntos de entrenamiento y prueba para validar los modelos.

La muestra final se concentra en los siete departamentos del Caribe colombiano: Atlántico, Bolívar, Cesar, Córdoba, La Guajira, Magdalena y Sucre. Se aplicaron filtros estrictos para garantizar la calidad de los datos, incluyendo solo observaciones con valores positivos en todas las variables clave y sin datos faltantes.

## Justificación de la selección de variables dependiente e independientes

```{js, echo=FALSE}
document.addEventListener('DOMContentLoaded', function() {
  // Smooth scroll para navegación académica
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });
  
  // Resaltado de sección activa en TOC
  const sections = document.querySelectorAll('h2, h3');
  const navLinks = document.querySelectorAll('.tocify-item a');
  
  window.addEventListener('scroll', () => {
    let current = '';
    sections.forEach(section => {
      const sectionTop = section.offsetTop;
      const sectionHeight = section.clientHeight;
      if (scrollY >= (sectionTop - 100)) {
        current = section.getAttribute('id');
      }
    });
    
    navLinks.forEach(link => {
      link.classList.remove('active');
      if (link.getAttribute('href') === `#${current}`) {
        link.classList.add('active');
      }
    });
  });

  // Crear botón global
  const globalToggle = document.createElement("button");
  globalToggle.className = "global-code-toggle";
  globalToggle.innerHTML = "🔧 Control de Código";
  document.body.appendChild(globalToggle);

  // Estado global
  let allCodeVisible = true;

  // Función para crear controles individuales
  function initializeCodeToggles() {
    const codeChunks = document.querySelectorAll("pre.r, pre.python, pre.sourceCode");
    
    codeChunks.forEach((chunk, index) => {
      // Crear contenedor
      const container = document.createElement("div");
      container.className = "code-chunk";
      
      // Crear header
      const header = document.createElement("div");
      header.className = "code-header";
      
      // Obtener el lenguaje del código
      const language = chunk.className.includes("r") ? "R" : 
                      chunk.className.includes("python") ? "Python" : "Código";
      
      header.innerHTML = `
        <div class="chunk-title">
          <span class="code-status visible"></span>
          ${language} - Chunk ${index + 1}
        </div>
        <div class="toggle-icon">▼</div>
      `;
      
      // Crear contenido
      const content = document.createElement("div");
      content.className = "code-content expanded";
      content.appendChild(chunk.cloneNode(true));
      
      // Reemplazar el chunk original
      chunk.parentNode.replaceChild(container, chunk);
      container.appendChild(header);
      container.appendChild(content);
      
      // Agregar evento de click
      header.addEventListener("click", function() {
        const isExpanded = content.classList.contains("expanded");
        const icon = this.querySelector(".toggle-icon");
        const status = this.querySelector(".code-status");
        
        if (isExpanded) {
          content.classList.remove("expanded");
          content.classList.add("collapsed");
          icon.classList.add("rotated");
          status.classList.remove("visible");
          status.classList.add("hidden");
        } else {
          content.classList.remove("collapsed");
          content.classList.add("expanded");
          icon.classList.remove("rotated");
          status.classList.remove("hidden");
          status.classList.add("visible");
        }
      });
    });
  }

  // Función para toggle global
  function toggleAllCode() {
    const codeContents = document.querySelectorAll(".code-content");
    const headers = document.querySelectorAll(".code-header");
    
    if (allCodeVisible) {
      // Ocultar todo
      codeContents.forEach(content => {
        content.classList.remove("expanded");
        content.classList.add("collapsed");
      });
      headers.forEach(header => {
        const icon = header.querySelector(".toggle-icon");
        const status = header.querySelector(".code-status");
        icon.classList.add("rotated");
        status.classList.remove("visible");
        status.classList.add("hidden");
      });
      globalToggle.innerHTML = "🔧 Mostrar Código";
      allCodeVisible = false;
    } else {
      // Mostrar todo
      codeContents.forEach(content => {
        content.classList.remove("collapsed");
        content.classList.add("expanded");
      });
      headers.forEach(header => {
        const icon = header.querySelector(".toggle-icon");
        const status = header.querySelector(".code-status");
        icon.classList.remove("rotated");
        status.classList.remove("hidden");
        status.classList.add("visible");
      });
      globalToggle.innerHTML = "🔧 Ocultar Código";
      allCodeVisible = true;
    }
  }

  // Inicializar
  initializeCodeToggles();
  
  // Evento para el botón global
  globalToggle.addEventListener("click", toggleAllCode);

  // Agregar contenedor de controles globales
  const globalControls = document.createElement("div");
  globalControls.className = "code-toggle-container";
  globalControls.innerHTML = `
    <h4>Controles de Visualización de Código</h4>
    <p>Utilice los siguientes controles para gestionar la visualización del código en este documento académico</p>
    <button class="code-toggle-btn" onclick="window.toggleAllCode()">Mostrar/Ocultar Todo el Código</button>
    <button class="code-toggle-btn secondary" onclick="window.expandAllCode()">Expandir Todo</button>
    <button class="code-toggle-btn secondary" onclick="window.collapseAllCode()">Contraer Todo</button>
  `;

  // Insertar después del primer h1
  const firstHeading = document.querySelector("h1");
  if (firstHeading) {
    firstHeading.parentNode.insertBefore(globalControls, firstHeading.nextSibling);
  }

  // Funciones globales para los botones
  window.toggleAllCode = toggleAllCode;
  window.expandAllCode = function() {
    const codeContents = document.querySelectorAll(".code-content");
    const headers = document.querySelectorAll(".code-header");
    
    codeContents.forEach(content => {
      content.classList.remove("collapsed");
      content.classList.add("expanded");
    });
    headers.forEach(header => {
      const icon = header.querySelector(".toggle-icon");
      const status = header.querySelector(".code-status");
      icon.classList.remove("rotated");
      status.classList.remove("hidden");
      status.classList.add("visible");
    });
    globalToggle.innerHTML = "🔧 Ocultar Código";
    allCodeVisible = true;
  };

  window.collapseAllCode = function() {
    const codeContents = document.querySelectorAll(".code-content");
    const headers = document.querySelectorAll(".code-header");
    
    codeContents.forEach(content => {
      content.classList.remove("expanded");
      content.classList.add("collapsed");
    });
    headers.forEach(header => {
      const icon = header.querySelector(".toggle-icon");
      const status = header.querySelector(".code-status");
      icon.classList.add("rotated");
      status.classList.remove("visible");
      status.classList.add("hidden");
    });
    globalToggle.innerHTML = "🔧 Mostrar Código";
    allCodeVisible = false;
  };
});
```

