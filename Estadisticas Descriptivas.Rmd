---
title: "Análisis de Nacimientos - Bogotá 2024"
author: "Tu Nombre"
date: "2025-01-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r librerias, include=FALSE}
library(readr)
library(dplyr)
library(tidyverse)
library(kableExtra)
library(reactable)
library(plotly)
library(htmltools)
library(ggplot2)
```

```{r cargar_datos, include=FALSE}
# Configuración inicial - manteniendo tu código base
BD_EEVV <- read_csv("BD-EEVV-Nacimientos-2024.csv") %>%
  select(COD_DPTO, PESO_NAC, T_GES, TIPO_PARTO, NUMCONSUL, EDAD_MADRE, N_EMB, MES) %>%
  rename(
    Departamento = COD_DPTO,
    Peso_delicado = PESO_NAC,
    Tiempo_gestación = T_GES,
    Tipo_parto = TIPO_PARTO,
    Numero_control_prenatal = NUMCONSUL,
    Edad_madre = EDAD_MADRE,
    Numero_embarazos = N_EMB,
    Mes = MES
  ) %>%
  mutate(
    Numero_control_prenatal = as.numeric(Numero_control_prenatal),
    Numero_embarazos = as.numeric(Numero_embarazos),
    Tiempo_gestación = factor(Tiempo_gestación,
                              levels = c(1, 2, 3, 4, 5),
                              labels = c("22 o menos semanas", "22-27 semanas", "28-37 semanas",
                                         "38-41 semanas", "42 o más semanas"))
  ) %>%
  mutate(
    Peso_delicado = ifelse(Peso_delicado %in% c(5, 6, 7, 8, 9), "No", "Si"),
    Peso_delicado = factor(Peso_delicado, levels = c("Si", "No"))
  ) %>%
  mutate(Mes = as.numeric(Mes)) %>%
  filter(Mes %in% c(7, 8, 9, 10, 11, 12)) %>%
  filter(Departamento == 11) %>%
  mutate(Departamento = "Bogotá") %>%
  na.omit()
```

```{r balanceo_datos, include=FALSE}
# Balanceo
set.seed(5)
Si <- BD_EEVV %>% filter(Peso_delicado == "Si")
No <- BD_EEVV %>% filter(Peso_delicado == "No") %>% sample_n(6000)

# Base final
Base_datos <- bind_rows(Si, No) %>%
  select(Tiempo_gestación, Tipo_parto, Numero_control_prenatal,
         Edad_madre, Numero_embarazos, Peso_delicado) %>%
  mutate(
    Tipo_parto = case_when(
      Tipo_parto == 1 ~ "Espontaneo",
      Tipo_parto == 2 ~ "Cesarea",
      Tipo_parto == 3 ~ "Instrumentado"
    ),
    Edad_madre = case_when(
      Edad_madre == 1 ~ "10-14 años",
      Edad_madre == 2 ~ "15-19 años",
      Edad_madre == 3 ~ "20-24 años",
      Edad_madre == 4 ~ "25-29 años",
      Edad_madre == 5 ~ "30-34 años",
      Edad_madre == 6 ~ "35-39 años",
      Edad_madre == 7 ~ "40-44 años",
      Edad_madre == 8 ~ "45-49 años",
      Edad_madre == 9 ~ "50-54 años"
    ),
    Tipo_parto = as.factor(Tipo_parto),
    Edad_madre = as.factor(Edad_madre)
  ) %>%
  filter(complete.cases(.))
```

#TABLA DE VARIABLES

```{r tabla_variables, echo=FALSE}
# TABLA DE VARIABLES DEL MODELO
variables_modelo <- data.frame(
  Variable = c("Peso", "Tiempo gestación", "Tipo parto", 
               "Numero control prenatal", "Edad madre", "Numero embarazos"),
  Descripción = c("Clasificación del peso al nacer (Normal/Delicado)",
                 "Semanas de gestación", 
                 "Tipo de parto registrado",
                 "Número de controles prenatales realizados",
                 "Grupo etario de la madre",
                 "Número de embarazos previos"),
  Tipo_Variable = c("Categórica (binaria)", "Categórica ordinal", 
                   "Categórica nominal", "Cuantitativa discreta",
                   "Categórica ordinal", "Cuantitativa discreta"),
  Notas = c("Variable dependiente - Peso normal: ≥2500g", 
           "Considerar <37 semanas como prematurez",
           "Espontáneo/Cesárea/Instrumentado",
           "Indicador de acceso a salud prenatal",
           "Recodificado a 9 rangos etarios (Códigos 1 a 9)",
           "Incluye embarazo actual")
)

kable(variables_modelo, 
      caption = "Tabla 1: Variables del Modelo",
      align = c("l", "l", "l", "l"),
      col.names = c("Variable", "Descripción", "Tipo de Variable", "Notas")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE,
                font_size = 12) %>%
  row_spec(0, background = "#2C3E50", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "12em") %>%
  footnote(general = "Fuente: Elaboración propia en base a la Base de Datos de Nacimientos - 2024",
           number = c("Datos corresponden al segundo semestre del año 2024"))
```

#BASE DE DATOS

```{r tabla_interactiva, echo=FALSE}
# TABLA INTERACTIVA FINAL
library(htmltools)
reactable(
  Base_datos,
  defaultPageSize = 15,
  showPageSizeOptions = TRUE,
  pageSizeOptions = c(10, 15, 25, 50, 100),
  filterable = TRUE,
  searchable = TRUE,
  sortable = TRUE,
  resizable = TRUE,
  striped = TRUE,
  highlight = TRUE,
  bordered = FALSE,
  wrap = FALSE,
  showSortable = TRUE,
  defaultColDef = colDef(
    header = function(value) {
      name <- gsub("_", " ", value)
      name <- gsub("([a-z])([A-Z])", "\\1 \\2", name)
      tools::toTitleCase(tolower(name))
    },
    cell = function(value) {
      if (is.numeric(value)) {
        if (value == round(value)) {
          format(value, big.mark = ",", scientific = FALSE)
        } else {
          format(round(value, 2), nsmall = 2, big.mark = ",", scientific = FALSE)
        }
      } else {
        as.character(value)
      }
    },
    align = "center",
    minWidth = 100,
    headerStyle = list(
      background = "#2C3E50",
      color = "white",
      fontWeight = "600",
      borderBottom = "2px solid #dee2e6",
      fontSize = "13px"
    ),
    style = list(
      fontSize = "12px",
      fontFamily = "Arial, sans-serif"
    )
  ),
  style = list(
    fontFamily = "Arial, sans-serif",
    fontSize = "13px"
  ),
  theme = reactableTheme(
    stripedColor = "#f8f9fa",
    highlightColor = "#e9ecef",
    cellPadding = "8px 12px",
    backgroundColor = "#ffffff",
    borderColor = "#dee2e6",
    style = list(
      fontFamily = "Arial, -apple-system, BlinkMacSystemFont, sans-serif"
    ),
    searchInputStyle = list(
      width = "100%",
      padding = "8px 12px",
      border = "1px solid #ced4da",
      borderRadius = "4px",
      fontSize = "14px",
      marginBottom = "10px"
    ),
    headerStyle = list(
      borderBottom = "2px solid #495057",
      fontSize = "14px",
      backgroundColor = "#2C3E50",
      color = "white"
    )
  ),
  columns = list(
    Tiempo_gestación = colDef(
      name = "Tiempo Gestación",
      minWidth = 180,
      filterable = TRUE,
      align = "left"
    ),
    Edad_madre = colDef(
      name = "Edad Madre", 
      minWidth = 120,
      filterable = TRUE
    ),
    Peso_delicado = colDef(
      name = "Peso Delicado",
      style = function(value) {
        color <- ifelse(value == "Si", "#E74C3C", "#27AE60")
        list(fontWeight = "bold", color = color)
      }
    )
  )
)

# Fuente de la tabla interactiva
tags$div(
  style = "margin-top: 20px; font-size: 12px; color: #666; font-style: italic; text-align: center;",
  "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024"
)
```

#Y1 PESO DELICADO

# TABLA 1: ESTADÍSTICAS DESCRIPTIVAS POR GRUPO DE PESO

# tablas separadas

```{r tabla1_1_tamano_muestral, echo=FALSE}
# TABLA 1.1: TAMAÑO MUESTRAL POR GRUPO DE PESO
tabla_1_1 <- Base_datos %>%
  group_by(Peso_delicado) %>%
  summarise(
    n = n(),
    Porcentaje = round(100 * n() / nrow(Base_datos), 1)
  )

kable(tabla_1_1, 
      align = c("l", "r", "r"),
      format.args = list(big.mark = ",", decimal.mark = "."),
      col.names = c("Peso Delicado", "N", "%"),
      caption = "TABLA 1.1. TAMAÑO MUESTRAL POR GRUPO DE PESO AL NACER") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE,
    font_size = 12,
    position = "center"
  ) %>%
  add_header_above(c(" " = 1, "Tamaño Muestral" = 2),
                   background = "#2C3E50", color = "white") %>%
  row_spec(0, background = "#34495E", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "12em") %>%
  column_spec(2:3, background = "#F4F6F6") %>%
  footnote(
    general = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024.",
    number = c("Datos corresponden a nacimientos en Bogotá (julio-diciembre 2024)")
  )
```

```{r tabla1_2_controles_prenatales, echo=FALSE}
# TABLA 1.2: CONTROLES PRENATALES POR GRUPO DE PESO
tabla_1_2 <- Base_datos %>%
  group_by(Peso_delicado) %>%
  summarise(
    Media = round(mean(Numero_control_prenatal, na.rm = TRUE), 1),
    DE = round(sd(Numero_control_prenatal, na.rm = TRUE), 1),
    Min = min(Numero_control_prenatal, na.rm = TRUE),
    Max = max(Numero_control_prenatal, na.rm = TRUE)
  )

kable(tabla_1_2, 
      align = c("l", "r", "r", "r", "r"),
      format.args = list(big.mark = ",", decimal.mark = "."),
      col.names = c("Peso Delicado", "Media", "DE", "Mín", "Máx"),
      caption = "TABLA 1.2. CONTROLES PRENATALES POR GRUPO DE PESO AL NACER") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE,
    font_size = 12,
    position = "center"
  ) %>%
  add_header_above(c(" " = 1, "Controles Prenatales" = 4),
                   background = "#2C3E50", color = "white") %>%
  row_spec(0, background = "#34495E", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "12em") %>%
  column_spec(2:5, background = "#E8F8F5") %>%
  footnote(
    general = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024.",
    number = c("Datos corresponden a nacimientos en Bogotá (julio-diciembre 2024)")
  )
```

```{r tabla1_3_numero_embarazos, echo=FALSE}
# TABLA 1.3: NÚMERO DE EMBARAZOS POR GRUPO DE PESO
tabla_1_3 <- Base_datos %>%
  group_by(Peso_delicado) %>%
  summarise(
    Media = round(mean(Numero_embarazos, na.rm = TRUE), 1),
    DE = round(sd(Numero_embarazos, na.rm = TRUE), 1),
    Min = min(Numero_embarazos, na.rm = TRUE),
    Max = max(Numero_embarazos, na.rm = TRUE)
  )

kable(tabla_1_3, 
      align = c("l", "r", "r", "r", "r"),
      format.args = list(big.mark = ",", decimal.mark = "."),
      col.names = c("Peso Delicado", "Media", "DE", "Mín", "Máx"),
      caption = "TABLA 1.3. NÚMERO DE EMBARAZOS POR GRUPO DE PESO AL NACER") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE,
    font_size = 12,
    position = "center"
  ) %>%
  add_header_above(c(" " = 1, "Número de Embarazos" = 4),
                   background = "#2C3E50", color = "white") %>%
  row_spec(0, background = "#34495E", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "12em") %>%
  column_spec(2:5, background = "#FEF5E7") %>%
  footnote(
    general = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024.",
    number = c("Datos corresponden a nacimientos en Bogotá (julio-diciembre 2024)")
  )
```

#X1 TIEMPO DE GESTACION

```{r tabla2_tiempo_gestacion, echo=FALSE}
# TABLA 2: DISTRIBUCIÓN DEL TIEMPO DE GESTACIÓN
tabla_tiempo_gestacion <- Base_datos %>%
  count(Tiempo_gestación) %>%
  mutate(
    Porcentaje = round(100 * n / sum(n), 1),
    Porcentaje_Acumulado = cumsum(Porcentaje)
  )

kable(tabla_tiempo_gestacion, 
      align = c("l", "c", "r", "r"),
      col.names = c("Tiempo de Gestación", "Frecuencia", "Porcentaje (%)", "Porcentaje Acumulado (%)"),
      caption = "TABLA 2. DISTRIBUCIÓN DEL TIEMPO DE GESTACIÓN") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 12
  ) %>%
  add_header_above(c(" " = 1, "Distribución de Frecuencias" = 3),
                   background = "#2C3E50", color = "white") %>%
  row_spec(0, background = "#34495E", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "20em") %>%
  column_spec(2:4, background = "#F4F6F6") %>%
  footnote(
    general = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024."
  )
```

```{r grafico2_tiempo_vs_peso, echo=FALSE, fig.width=10, fig.height=6}
# GRÁFICO 2: RELACIÓN TIEMPO DE GESTACIÓN VS PESO DELICADO (BARRAS APILADAS)
tabla_tiempo_peso <- Base_datos %>%
  count(Tiempo_gestación, Peso_delicado)

plot_ly(
  tabla_tiempo_peso,
  x = ~Tiempo_gestación,
  y = ~n,
  color = ~Peso_delicado,
  colors = c('#27AE60', '#E74C3C'),  # Verde para No, Rojo para Si
  type = 'bar',
  text = ~n,
  textposition = 'inside',
  hovertemplate = paste(
    '<b>%{x}</b><br>',
    'Peso Delicado: %{fullData.name}<br>',
    'Frecuencia: %{y}<br>',
    '<extra></extra>'
  )
) %>%
  plotly::layout(
    barmode = 'stack',
    title = list(
      text = "<b>Gráfico 2. Tiempo de Gestación según Peso Delicado</b><br><sub>Bogotá - Segundo Semestre 2024</sub>",
      x = 0.5,
      font = list(size = 16)
    ),
    xaxis = list(
      title = "<b>Tiempo de Gestación</b>",
      tickfont = list(size = 10)
    ),
    yaxis = list(
      title = "<b>Frecuencia</b>"
    ),
    legend = list(
      title = list(text = "<b>Peso Delicado</b>"),
      orientation = "v",
      x = 1.02,
      y = 1
    ),
    annotations = list(
      list(
        text = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024",
        xref = "paper",
        yref = "paper",
        x = 0.5,
        y = -0.25,
        showarrow = FALSE,
        font = list(size = 10, color = "#666666"),
        xanchor = "center"
      )
    ),
    margin = list(b = 150)
  )
```

#X2 TIPO DE PARTO

```{r tabla3_tipo_parto, echo=FALSE}
# TABLA 3: DISTRIBUCIÓN DEL TIPO DE PARTO
tabla_tipo_parto <- Base_datos %>%
  count(Tipo_parto) %>%
  mutate(
    Porcentaje = round(100 * n / sum(n), 1),
    Porcentaje_Acumulado = cumsum(Porcentaje)
  )

kable(tabla_tipo_parto, 
      align = c("l", "c", "r", "r"),
      col.names = c("Tipo de Parto", "Frecuencia", "Porcentaje (%)", "Porcentaje Acumulado (%)"),
      caption = "TABLA 3. DISTRIBUCIÓN DEL TIPO DE PARTO") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 12
  ) %>%
  add_header_above(c(" " = 1, "Distribución de Frecuencias" = 3),
                   background = "#2C3E50", color = "white") %>%
  row_spec(0, background = "#34495E", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "15em") %>%
  column_spec(2:4, background = "#F4F6F6") %>%
  row_spec(1:nrow(tabla_tipo_parto), background = c("#FBFCFC", "#F4F6F6")) %>%
  footnote(
    general = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024."
  )
```

```{r grafica3s, echo=FALSE}
# GRÁFICO 3: DISTRIBUCIÓN DEL TIPO DE PARTO (SUNBURST)
tabla_parto_sunburst <- Base_datos %>%
  count(Tipo_parto, Peso_delicado) %>%
  mutate(
    # Crear jerarquía: Total -> Tipo_parto -> Peso_delicado
    labels = case_when(
      !is.na(Peso_delicado) ~ paste(Tipo_parto, "-", Peso_delicado),
      TRUE ~ Tipo_parto
    ),
    parents = case_when(
      !is.na(Peso_delicado) ~ Tipo_parto,
      TRUE ~ "Total"
    )
  )

# Agregar el nodo raíz "Total"
nodo_total <- tibble(
  labels = "Total",
  parents = "",
  n = sum(tabla_parto_sunburst$n)
)

# Agregar nodos intermedios (Tipo_parto)
nodos_tipo_parto <- Base_datos %>%
  count(Tipo_parto) %>%
  mutate(
    labels = Tipo_parto,
    parents = "Total"
  ) %>%
  select(labels, parents, n)

# Combinar todos los datos
datos_sunburst <- bind_rows(
  nodo_total,
  nodos_tipo_parto,
  tabla_parto_sunburst %>% select(labels, parents, n)
)

# Crear el gráfico sunburst
plot_ly(
  datos_sunburst,
  labels = ~labels,
  parents = ~parents,
  values = ~n,
  type = 'sunburst',
  branchvalues = 'total',
  marker = list(
    colors = c('#9B59B6', '#1ABC9C', '#F39C12', '#E74C3C', '#3498DB', '#F1C40F'),
    line = list(color = '#FFFFFF', width = 2)
  ),
  hovertemplate = paste(
    '<b>%{label}</b><br>',
    'Frecuencia: %{value}<br>',
    'Porcentaje: %{percentParent}<br>',
    '<extra></extra>'
  )
) %>%
  layout(
    title = list(
      text = "<b>Gráfico 3. Distribución del Tipo de Parto</b><br><sub>Bogotá - Segundo Semestre 2024</sub>",
      x = 0.5,
      font = list(size = 16)
    ),
    annotations = list(
      list(
        text = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024",
        xref = "paper",
        yref = "paper",
        x = 0.5,
        y = -0.1,
        showarrow = FALSE,
        font = list(size = 10, color = "#666666"),
        xanchor = "center"
      )
    ),
    margin = list(b = 100, t = 100)
  )

```

#X3 EDAD MADRE

```{r tabla4_edad_madre, echo=FALSE}
# TABLA 4: DISTRIBUCIÓN POR GRUPOS DE EDAD DE LA MADRE
tabla_edad_madre <- Base_datos %>%
  count(Edad_madre) %>%
  mutate(
    Porcentaje = round(100 * n / sum(n), 1)
  ) %>%
  # Extraer el número inicial del rango de edad para ordenar correctamente
  mutate(
    Edad_inicial = as.numeric(gsub("(\\d+)-.*", "\\1", Edad_madre))
  ) %>%
  arrange(Edad_inicial) %>%  # Ordenar por edad de menor a mayor
  mutate(
    Porcentaje_Acumulado = cumsum(Porcentaje)  # Recalcular después de ordenar
  ) %>%
  select(-Edad_inicial)  # Eliminar columna auxiliar

kable(tabla_edad_madre, 
      align = c("l", "c", "r", "r"),
      col.names = c("Grupo de Edad", "Frecuencia", "Porcentaje (%)", "Porcentaje Acumulado (%)"),
      caption = "TABLA 4. DISTRIBUCIÓN POR GRUPOS DE EDAD DE LA MADRE") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 12
  ) %>%
  add_header_above(c(" " = 1, "Distribución de Frecuencias" = 3),
                   background = "#2C3E50", color = "white") %>%
  row_spec(0, background = "#34495E", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "12em") %>%
  column_spec(2:4, background = "#F4F6F6") %>%
  row_spec(1:nrow(tabla_edad_madre), 
           background = rep(c("#FBFCFC", "#F4F6F6"), length.out = nrow(tabla_edad_madre))) %>%
  footnote(
    general = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024."
  )
```

```{r grafico4_edad_madre_grouped, echo=FALSE, fig.width=12, fig.height=7}
# GRÁFICO 4:EDAD MADRE BARRAS AGRUPADAS
#Preparar datos para barras agrupadas

tabla_edad_peso <- Base_datos %>%
  count(Edad_madre, Peso_delicado) %>%
  group_by(Edad_madre) %>%
  mutate(
    Total = sum(n),
    Porcentaje = round(100 * n / Total, 1)
  ) %>%
  ungroup()

# Crear gráfico de barras agrupadas
plot_ly(
  tabla_edad_peso,
  x = ~Edad_madre,
  y = ~n,
  color = ~Peso_delicado,
  colors = c('#27AE60', '#E74C3C'),
  type = 'bar',
  text = ~paste0(n, " (", Porcentaje, "%)"),
  textposition = 'outside',
  textfont = list(size = 10),
  hovertemplate = paste(
    '<b>Edad: %{x}</b><br>',
    'Peso Delicado: %{fullData.name}<br>',
    'Frecuencia: %{y}<br>',
    'Porcentaje: %{text}<br>',
    '<extra></extra>'
  )
) %>%
  plotly::layout(
    barmode = 'group',
    title = list(
      text = "<b>Gráfico 4. Distribución de Peso Delicado según Edad Materna</b><br><sub>Bogotá - Segundo Semestre 2024</sub>",
      x = 0.5,
      font = list(size = 16)
    ),
    xaxis = list(
      title = "<b>Edad de la Madre</b>",
      tickfont = list(size = 10),
      tickangle = -45
    ),
    yaxis = list(
      title = "<b>Frecuencia</b>"
    ),
    legend = list(
      title = list(text = "<b>Peso Delicado</b>"),
      orientation = "h",
      x = 0.5,
      xanchor = "center",
      y = -0.25
    ),
    annotations = list(
      list(
        text = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024",
        xref = "paper",
        yref = "paper",
        x = 0.5,
        y = -0.35,
        showarrow = FALSE,
        font = list(size = 10, color = "#666666"),
        xanchor = "center"
      )
    ),
    margin = list(b = 150, l = 80, r = 50, t = 100)
  )
```

#X4 NUMERO CONTROLES PRENATALES

```{r tabla5_controles_prenatales, echo=FALSE}
# TABLA 5: ESTADÍSTICAS DE CONTROLES PRENATALES
tabla_controles <- Base_datos %>%
  summarise(
    Variable = "Controles Prenatales",
    Media = round(mean(Numero_control_prenatal, na.rm = TRUE), 1),
    DE = round(sd(Numero_control_prenatal, na.rm = TRUE), 1),
    Mínimo = min(Numero_control_prenatal, na.rm = TRUE),
    Máximo = max(Numero_control_prenatal, na.rm = TRUE),
    Q1 = quantile(Numero_control_prenatal, 0.25, na.rm = TRUE),
    Mediana = median(Numero_control_prenatal, na.rm = TRUE),
    Q3 = quantile(Numero_control_prenatal, 0.75, na.rm = TRUE)
  )

kable(tabla_controles,
      caption = "TABLA 5. ESTADÍSTICAS DESCRIPTIVAS - CONTROLES PRENATALES",
      align = c("l", "r", "r", "r", "r", "r", "r", "r")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE,
                font_size = 12) %>%
  add_header_above(c(" " = 1, "Medidas de Tendencia Central" = 3, 
                     "Medidas de Dispersión" = 4),
                   background = "#2C3E50", color = "white") %>%
  row_spec(0, background = "#34495E", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "12em") %>%
  footnote(general = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024.")
```

#grafico 5

```{r grafico5_controles_prenatales, echo=FALSE, fig.width=12, fig.height=7}
# GRÁFICO 5 INTERACTIVO: DISTRIBUCIÓN DE CONTROLES PRENATALES CON ZONAS DE RIESGO
library(plotly)
library(dplyr)

# Calcular estadísticas
stats_controles <- Base_datos %>%
  summarise(
    Media = round(mean(Numero_control_prenatal, na.rm = TRUE), 1),
    Mediana = median(Numero_control_prenatal, na.rm = TRUE),
    DE = round(sd(Numero_control_prenatal, na.rm = TRUE), 1),
    Q1 = quantile(Numero_control_prenatal, 0.25, na.rm = TRUE),
    Q3 = quantile(Numero_control_prenatal, 0.75, na.rm = TRUE),
    Min = min(Numero_control_prenatal, na.rm = TRUE),
    Max = max(Numero_control_prenatal, na.rm = TRUE)
  )

# Crear datos de frecuencia
freq_data <- Base_datos %>%
  count(Numero_control_prenatal) %>%
  mutate(
    Zona = case_when(
      Numero_control_prenatal < 4 ~ "Crítico (<4)",
      Numero_control_prenatal < 8 ~ "Insuficiente (4-7)",
      TRUE ~ "Adecuado (≥8)"
    )
  )

# Crear gráfico interactivo
fig <- plot_ly() %>%
  # Barras coloreadas por zona de riesgo
  add_bars(
    data = freq_data,
    x = ~Numero_control_prenatal,
    y = ~n,
    color = ~Zona,
    colors = c("Crítico (<4)" = "#e74c3c", 
               "Insuficiente (4-7)" = "#f39c12", 
               "Adecuado (≥8)" = "#27ae60"),
    text = ~n,
    textposition = "outside",
    textfont = list(size = 11, color = "#2C3E50", family = "Arial"),
    hovertemplate = paste(
      "<b>%{x} controles</b><br>",
      "Frecuencia: %{y}<br>",
      "Zona: %{fullData.name}<br>",
      "<extra></extra>"
    )
  ) %>%
  # Línea vertical para la media
  add_segments(
    x = stats_controles$Media,
    xend = stats_controles$Media,
    y = 0,
    yend = max(freq_data$n) * 1.1,
    line = list(color = "#e67e22", width = 3, dash = "dash"),
    showlegend = FALSE,
    hoverinfo = "skip"
  ) %>%
  # Línea vertical para la mediana
  add_segments(
    x = stats_controles$Mediana,
    xend = stats_controles$Mediana,
    y = 0,
    yend = max(freq_data$n) * 1.1,
    line = list(color = "#2C3E50", width = 3, dash = "dot"),
    showlegend = FALSE,
    hoverinfo = "skip"
  ) %>%
  # Línea vertical para recomendación OMS (8 controles)
  add_segments(
    x = 8,
    xend = 8,
    y = 0,
    yend = max(freq_data$n) * 1.1,
    line = list(color = "#8e44ad", width = 3, dash = "solid"),
    showlegend = FALSE,
    hoverinfo = "skip"
  ) %>%
  layout(
    title = list(
      text = "<b>FIGURA 5. Distribución de Controles Prenatales y Zonas de Riesgo</b><br><sub>Clasificación según recomendaciones de la OMS</sub>",
      font = list(size = 16, family = "Arial, sans-serif"),
      x = 0
    ),
    xaxis = list(
      title = "<b>Número de Controles Prenatales</b>",
      titlefont = list(size = 14, family = "Arial, sans-serif"),
      tickfont = list(size = 12),
      dtick = 1,
      gridcolor = "#ecf0f1"
    ),
    yaxis = list(
      title = "<b>Frecuencia Absoluta</b>",
      titlefont = list(size = 14, family = "Arial, sans-serif"),
      tickfont = list(size = 12),
      gridcolor = "#ecf0f1"
    ),
    plot_bgcolor = "white",
    paper_bgcolor = "white",
    hovermode = "closest",
    showlegend = TRUE,
    legend = list(
      title = list(text = "<b>Zona de Riesgo</b>", font = list(size = 12)),
      x = 0.02,
      y = 0.98,
      bgcolor = "rgba(255, 255, 255, 0.95)",
      bordercolor = "#2C3E50",
      borderwidth = 1,
      font = list(size = 11, family = "Arial, sans-serif")
    ),
    margin = list(t = 120, b = 120, l = 80, r = 80),
    annotations = list(
      # Recomendacion OMS
      list(
        x = 0.98,
        y = 0.98,
        xref = "paper",
        yref = "paper",
          text = "<b>Recomendación OMS: ≥8</b>",
        showarrow = FALSE,
        font = list(size = 11, color = "#8e44ad", family = "Arial"),
        bgcolor = "rgba(142, 68, 173, 0.1)",
        bordercolor = "#8e44ad",
        borderwidth = 2,
        borderpad = 6
      ),
      # Etiqueta Media
      list(
        x = stats_controles$Media,
        y = max(freq_data$n) * 1.12,
        text = paste0("Media: ", stats_controles$Media),
        showarrow = FALSE,
        font = list(size = 10, color = "#e67e22", family = "Arial"),
        bgcolor = "rgba(255, 255, 255, 0.8)",
        bordercolor = "#e67e22",
        borderwidth = 1,
        borderpad = 4
      ),
      # Etiqueta Mediana
      list(
        x = stats_controles$Mediana,
        y = max(freq_data$n) * 1.18,
        text = paste0("Mediana: ", stats_controles$Mediana),
        showarrow = FALSE,
        font = list(size = 10, color = "#2C3E50", family = "Arial"),
        bgcolor = "rgba(255, 255, 255, 0.8)",
        bordercolor = "#2C3E50",
        borderwidth = 1,
        borderpad = 4
      ),
      # Caption
      list(
        x = 0,
        y = -0.18,
        xref = "paper",
        yref = "paper",
        text = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024.<br>Línea naranja: media | Línea gris: mediana | Línea morada: recomendación OMS (≥8 controles)",
        showarrow = FALSE,
        xanchor = "left",
        font = list(size = 9, color = "#7f8c8d", family = "Arial, sans-serif")
      )
    ),
    barmode = "overlay"
  ) %>%
  config(
    displayModeBar = TRUE,
    modeBarButtonsToRemove = c("lasso2d", "select2d"),
    displaylogo = FALSE,
    toImageButtonOptions = list(
      format = "png",
      filename = "figura5_controles_prenatales",
      height = 600,
      width = 1000
    )
  )

fig
```

# X5 NUMEROS DE EMBARAZOS

```{r tabla6_numero_embarazos, echo=FALSE}
# TABLA 6: ESTADÍSTICAS DE NÚMERO DE EMBARAZOS
tabla_embarazos <- Base_datos %>%
  summarise(
    Variable = "Número de Embarazos",
    Media = round(mean(Numero_embarazos, na.rm = TRUE), 1),
    DE = round(sd(Numero_embarazos, na.rm = TRUE), 1),
    Mínimo = min(Numero_embarazos, na.rm = TRUE),
    Máximo = max(Numero_embarazos, na.rm = TRUE),
    Q1 = quantile(Numero_embarazos, 0.25, na.rm = TRUE),
    Mediana = median(Numero_embarazos, na.rm = TRUE),
    Q3 = quantile(Numero_embarazos, 0.75, na.rm = TRUE)
  )

kable(tabla_embarazos,
      caption = "TABLA 6. ESTADÍSTICAS DESCRIPTIVAS - NÚMERO DE EMBARAZOS",
      align = c("l", "r", "r", "r", "r", "r", "r", "r")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = FALSE,
                font_size = 12) %>%
  add_header_above(c(" " = 1, "Medidas de Tendencia Central" = 3, 
                     "Medidas de Dispersión" = 4),
                   background = "#2C3E50", color = "white") %>%
  row_spec(0, background = "#34495E", color = "white", bold = TRUE) %>%
  column_spec(1, bold = TRUE, width = "12em") %>%
  footnote(general = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024.")
```

```{r grafico6_numero_embarazos_boxplot,echo=FALSE}
# GRÁFICO 6: BOXPLOT COMPARATIVO - NÚMERO DE EMBARAZOS POR PESO DELICADO

# Primero calculamos las estadísticas para las anotaciones
stats_embarazos <- Base_datos %>%
  group_by(Peso_delicado) %>%
  summarise(
    Media = round(mean(Numero_embarazos, na.rm = TRUE), 2),
    Mediana = median(Numero_embarazos, na.rm = TRUE),
    Q1 = quantile(Numero_embarazos, 0.25, na.rm = TRUE),
    Q3 = quantile(Numero_embarazos, 0.75, na.rm = TRUE),
    Min = min(Numero_embarazos, na.rm = TRUE),
    Max = max(Numero_embarazos, na.rm = TRUE),
    n = n()
  )

g6_boxplot <- ggplot(Base_datos, aes(x = Peso_delicado, y = Numero_embarazos, fill = Peso_delicado)) +
  # Boxplot principal
  geom_boxplot(alpha = 0.7, outlier.shape = 21, outlier.size = 2, 
               outlier.fill = "white", outlier.color = "#e74c3c", width = 0.6) +
  # Marcar la media con un rombo
  stat_summary(fun = mean, geom = "point", shape = 23, size = 4, 
               color = "#e67e22", fill = "#e67e22", stroke = 1.5) +
  # Colores personalizados
  scale_fill_manual(values = c("No" = "#3498db", "Sí" = "#e74c3c"),
                    name = "Peso Delicado") +
  # Etiquetas y títulos
  labs(
    title = "FIGURA 6. Distribución del Número de Embarazos según Peso Delicado",
    subtitle = "Comparación de medidas de tendencia central y dispersión",
    x = "Peso Delicado",
    y = "Número de Embarazos",
    caption = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024.\nRombo naranja: media | Línea central: mediana | Caja: Q1-Q3 | Bigotes: rango | Puntos rojos: valores atípicos"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0, margin = margin(b = 5)),
    plot.subtitle = element_text(size = 10, color = "#7f8c8d", margin = margin(b = 15)),
    plot.caption = element_text(size = 8, hjust = 0, color = "#7f8c8d", 
                                margin = margin(t = 15), lineheight = 1.2),
    legend.position = "none",
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_line(color = "#ecf0f1", linewidth = 0.5),
    axis.title = element_text(face = "bold", size = 11),
    axis.text = element_text(size = 10),
    axis.text.x = element_text(size = 11, face = "bold"),
    plot.margin = margin(20, 20, 20, 20)
  ) +
  scale_y_continuous(breaks = seq(0, max(Base_datos$Numero_embarazos, na.rm = TRUE), by = 1))

# Añadir tabla de estadísticas al lado del gráfico
g6_con_stats <- g6_boxplot +
  # Cuadro con estadísticas para "No"
  annotate("rect",
           xmin = 0.55, xmax = 1.45,
           ymin = max(Base_datos$Numero_embarazos, na.rm = TRUE) * 0.82,
           ymax = max(Base_datos$Numero_embarazos, na.rm = TRUE) * 1.0,
           fill = "white", color = "#3498db", linewidth = 1.2, alpha = 0.95) +
  annotate("text",
           x = 1,
           y = max(Base_datos$Numero_embarazos, na.rm = TRUE) * 0.91,
           label = paste0("Peso NO Delicado\n",
                         "Media: ", stats_embarazos$Media[stats_embarazos$Peso_delicado == "No"], "\n",
                         "Mediana: ", stats_embarazos$Mediana[stats_embarazos$Peso_delicado == "No"], "\n",
                         "Q1: ", stats_embarazos$Q1[stats_embarazos$Peso_delicado == "No"],
                         " | Q3: ", stats_embarazos$Q3[stats_embarazos$Peso_delicado == "No"]),
           size = 3, fontface = "bold", color = "#2C3E50", lineheight = 0.9) +
  # Cuadro con estadísticas para "Sí"
  annotate("rect",
           xmin = 1.55, xmax = 2.45,
           ymin = max(Base_datos$Numero_embarazos, na.rm = TRUE) * 0.82,
           ymax = max(Base_datos$Numero_embarazos, na.rm = TRUE) * 1.0,
           fill = "white", color = "#e74c3c", linewidth = 1.2, alpha = 0.95) +
  annotate("text",
           x = 2,
           y = max(Base_datos$Numero_embarazos, na.rm = TRUE) * 0.91,
           label = paste0("Peso Delicado\n",
                         "Media: ", stats_embarazos$Media[stats_embarazos$Peso_delicado == "Sí"], "\n",
                         "Mediana: ", stats_embarazos$Mediana[stats_embarazos$Peso_delicado == "Sí"], "\n",
                         "Q1: ", stats_embarazos$Q1[stats_embarazos$Peso_delicado == "Sí"],
                         " | Q3: ", stats_embarazos$Q3[stats_embarazos$Peso_delicado == "Sí"]),
           size = 3, fontface = "bold", color = "#2C3E50", lineheight = 0.9)

print(g6_con_stats)

```

#TABLAS FINALES

```{r tabla7_resumen, echo=FALSE}
# TABLA 7: RESUMEN GENERAL DE OBSERVACIONES
tabla_resumen <- Base_datos %>%
  count(Peso_delicado) %>%
  mutate(
    Porcentaje = round(100 * n / sum(n), 1),
    `Porcentaje Acumulado` = cumsum(Porcentaje),
    Categoria = ifelse(Peso_delicado == "Si", "Si", "No")
  ) %>%
  select(Categoria, n, Porcentaje, `Porcentaje Acumulado`)

kable(tabla_resumen, 
      align = c("l", "c", "r", "r"),
      col.names = c("Peso delicado", "Frecuencia", "Porcentaje (%)", "Porcentaje Acumulado (%)"),
      caption = "TABLA 7. RESUMEN GENERAL DE OBSERVACIONES POR PESO DELICADO (SI/NO)") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    font_size = 12,
    html_font = "Arial"
  ) %>%
  add_header_above(c(" " = 1, "Distribución de Frecuencias" = 3),
                   background = c("#2C3E50", "#16A085"),
                   color = "white") %>%
  row_spec(0, background = "#2C3E50", color = "white", bold = TRUE) %>%
  row_spec(1, background = "#E8F6F3", bold = TRUE) %>%
  row_spec(2, background = "#EBF5FB") %>%
  column_spec(1, bold = TRUE, width = "15em") %>%
  column_spec(2, width = "6em", background = "#F4F6F6") %>%
  column_spec(3:4, width = "8em") %>%
  footnote(
    general = "Fuente: Elaboración propia con base en la Encuesta de Nacimientos – DANE 2024."
  )
```
